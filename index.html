<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√±adir Canci√≥n a Cola de Spotify</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            padding: 20px; 
            background-color: #121212; 
            color: #FFFFFF; 
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { 
            color: #1DB954; 
            font-weight: 700; 
            margin-bottom: 15px; 
        }
        .subtitle {
            color: #b3b3b3;
            margin-bottom: 30px;
            font-size: 14px;
        }
        #search-container { 
            margin-bottom: 20px; 
            display: flex;
            gap: 10px; 
        }
        #results { 
            list-style: none; 
            padding: 0; 
        }
        #results li { 
            padding: 12px; 
            margin-bottom: 8px; 
            border: 1px solid #333; 
            background-color: #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
        }
        #results li:hover { 
            background-color: #404040; 
            transition: background-color 0.2s; 
        }
        input[type="text"] { 
            padding: 12px; 
            flex: 1;
            background-color: #333; 
            border: 1px solid #535353; 
            color: white; 
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #1DB954;
        }
        button { 
            background-color: #535353; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { 
            background-color: #666; 
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #search-button {
            background-color: #1DB954;
            font-weight: bold;
            padding: 12px 24px;
        }
        #search-button:hover:not(:disabled) {
            background-color: #1ed760;
        }
        .send-button { 
            background-color: #1DB954; 
            font-weight: bold; 
        }
        .send-button:hover { 
            background-color: #1ed760; 
        }
        #status { 
            margin-top: 20px; 
            font-weight: bold; 
            padding: 12px; 
            border-radius: 4px;
        }
        .success { 
            background-color: #0b3d1b; 
            color: #1DB954; 
        }
        .error { 
            background-color: #4d0000; 
            color: #ff3333; 
        }
        .warning {
            background-color: #4d3800;
            color: #ffaa00;
        }
        .info {
            background-color: #1a3a52;
            color: #4da6ff;
        }
        .album-art {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            border-radius: 4px;
            object-fit: cover;
        }
        .track-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .track-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .track-name {
            font-weight: bold;
            font-size: 15px;
        }
        .track-artist {
            font-size: 13px;
            color: #b3b3b3;
        }
        .track-album {
            font-size: 12px;
            color: #777;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #b3b3b3;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <h1>üéµ A√±adir Canci√≥n a Cola de Spotify</h1>
    <p class="subtitle">
        Busca cualquier canci√≥n y se a√±adir√° autom√°ticamente a la cola de reproducci√≥n
    </p>

    <div id="search-container">
        <input type="text" id="song-query" placeholder="Escribe el nombre de la canci√≥n..." autofocus>
        <button id="search-button">üîç Buscar</button>
    </div>

    <ul id="results"></ul>
    
    <div id="status"></div>

    <script>
        // =================================================================
        // CONFIGURACI√ìN
        // =================================================================
        const N8N_WEBHOOK_URL = 'https://n8n-server.griffin-paridae.ts.net/webhook-test/Busqueda';

        // =================================================================
        // EVENT LISTENERS
        // =================================================================
        document.getElementById('search-button').addEventListener('click', searchSong);
        
        document.getElementById('song-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchSong();
            }
        });

        // =================================================================
        // B√öSQUEDA
        // =================================================================
        async function searchSong() {
            const query = document.getElementById('song-query').value.trim();
            
            if (!query) {
                showStatus('Por favor escribe el nombre de una canci√≥n', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('results');
            const searchButton = document.getElementById('search-button');
            const statusElement = document.getElementById('status');
            
            // Deshabilitar bot√≥n mientras se busca
            searchButton.disabled = true;
            searchButton.innerHTML = '<span class="spinner">‚è≥</span> Buscando...';
            
            resultsDiv.innerHTML = '<li class="loading"><span class="spinner">üîç</span> Buscando en Spotify...</li>';
            statusElement.textContent = '';

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'search',
                        query: query
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Respuesta de n8n:', data);
                
                // Caso 1: Resultado √∫nico - ya a√±adido autom√°ticamente
                if (data.status === 'added') {
                    resultsDiv.innerHTML = '';
                    showStatus(`‚úÖ ¬°Listo! "${data.songName}" por ${data.artistName} se ha a√±adido a la cola`, 'success');
                    document.getElementById('song-query').value = '';
                }
                // Caso 2: M√∫ltiples resultados - usuario debe elegir
                else if (data.status === 'multiple' && data.tracks && data.tracks.length > 0) {
                    renderResults(data.tracks);
                    showStatus(`Se encontraron ${data.tracks.length} resultados. Selecciona la canci√≥n correcta:`, 'info');
                }
                // Caso 3: Sin resultados
                else if (data.status === 'no_results' || (data.tracks && data.tracks.length === 0)) {
                    resultsDiv.innerHTML = '<li>üòï No se encontraron canciones con ese nombre</li>';
                    showStatus('Intenta con otro t√©rmino de b√∫squeda', 'warning');
                }
                // Caso 4: Error desde n8n
                else if (data.status === 'error') {
                    throw new Error(data.message || 'Error desconocido desde n8n');
                }
                else {
                    throw new Error('Respuesta inesperada del servidor');
                }

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = '';
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showStatus('‚ùå No se puede conectar con el servidor. Verifica que n8n est√© en l√≠nea', 'error');
                } else {
                    showStatus(`‚ùå Error: ${error.message}`, 'error');
                }
            } finally {
                searchButton.disabled = false;
                searchButton.innerHTML = 'üîç Buscar';
            }
        }

        // =================================================================
        // RENDERIZAR RESULTADOS
        // =================================================================
        function renderResults(tracks) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (!tracks || tracks.length === 0) {
                resultsDiv.innerHTML = '<li>No se encontraron canciones.</li>';
                return;
            }

            tracks.forEach(track => {
                const li = document.createElement('li');
                
                li.innerHTML = `
                    <div class="track-info">
                        ${track.albumArt ? `<img src="${track.albumArt}" alt="Album" class="album-art">` : ''}
                        <div class="track-details">
                            <div class="track-name">${escapeHtml(track.name)}</div>
                            <div class="track-artist">${escapeHtml(track.artists)}</div>
                            ${track.album ? `<div class="track-album">${escapeHtml(track.album)}</div>` : ''}
                        </div>
                    </div>
                    <button class="send-button">‚úì A√±adir</button>
                `;
                
                resultsDiv.appendChild(li);

                li.querySelector('.send-button').addEventListener('click', () => {
                    addToQueue(track.uri, track.name, track.artists);
                });
            });
        }

        // =================================================================
        // A√ëADIR A COLA (selecci√≥n manual)
        // =================================================================
        async function addToQueue(uri, name, artist) {
            const statusElement = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusElement.className = 'info';
            statusElement.textContent = `‚è≥ A√±adiendo "${name}" a la cola...`;

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        trackUri: uri,
                        songName: name,
                        artistName: artist
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                console.log('Respuesta de a√±adir:', data);
                
                if (data.status === 'success' || data.status === 'added') {
                    resultsDiv.innerHTML = '';
                    showStatus(`‚úÖ ¬°Perfecto! "${name}" se ha a√±adido a la cola`, 'success');
                    document.getElementById('song-query').value = '';
                } else if (data.status === 'error') {
                    throw new Error(data.message || 'Error al a√±adir la canci√≥n');
                } else {
                    throw new Error('Respuesta inesperada del servidor');
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error al a√±adir la canci√≥n: ${error.message}`, 'error');
            }
        }

        // =================================================================
        // UTILIDADES
        // =================================================================
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.className = type;
            statusElement.textContent = message;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>