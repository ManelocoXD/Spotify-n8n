<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√±adir Canci√≥n a Cola de Spotify</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            padding: 20px; 
            background-color: #121212; 
            color: #FFFFFF; 
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { 
            color: #1DB954; 
            font-weight: 700; 
            margin-bottom: 15px; 
        }
        .subtitle {
            color: #b3b3b3;
            margin-bottom: 30px;
            font-size: 14px;
        }
        #search-container { 
            margin-bottom: 20px; 
            display: flex;
            gap: 10px; 
        }
        #results { 
            list-style: none; 
            padding: 0; 
        }
        #results li { 
            padding: 12px; 
            margin-bottom: 8px; 
            border: 1px solid #333; 
            background-color: #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
        }
        #results li:hover { 
            background-color: #404040; 
            transition: background-color 0.2s; 
        }
        input[type="text"] { 
            padding: 12px; 
            flex: 1;
            background-color: #333; 
            border: 1px solid #535353; 
            color: white; 
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #1DB954;
        }
        button { 
            background-color: #535353; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { 
            background-color: #666; 
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #search-button {
            background-color: #1DB954;
            font-weight: bold;
            padding: 12px 24px;
        }
        #search-button:hover:not(:disabled) {
            background-color: #1ed760;
        }
        .send-button { 
            background-color: #1DB954; 
            font-weight: bold; 
        }
        .send-button:hover { 
            background-color: #1ed760; 
        }
        #status { 
            margin-top: 20px; 
            font-weight: bold; 
            padding: 12px; 
            border-radius: 4px;
        }
        .success { 
            background-color: #0b3d1b; 
            color: #1DB954; 
        }
        .error { 
            background-color: #4d0000; 
            color: #ff3333; 
        }
        .warning {
            background-color: #4d3800;
            color: #ffaa00;
        }
        .info {
            background-color: #1a3a52;
            color: #4da6ff;
        }
        .album-art {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            border-radius: 4px;
            object-fit: cover;
        }
        .track-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .track-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .track-name {
            font-weight: bold;
            font-size: 15px;
        }
        .track-artist {
            font-size: 13px;
            color: #b3b3b3;
        }
        .track-album {
            font-size: 12px;
            color: #777;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #b3b3b3;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <h1>üéµ A√±adir Canci√≥n a Cola de Spotify</h1>
    <p class="subtitle">
        Busca cualquier canci√≥n y se a√±adir√° autom√°ticamente a la cola de reproducci√≥n
    </p>

    <div id="search-container">
        <input type="text" id="song-query" placeholder="Escribe el nombre de la canci√≥n..." autofocus>
        <button id="search-button">üîç Buscar</button>
    </div>

    <ul id="results"></ul>
    
    <div id="status"></div>

    <script>
        // =================================================================
        // CONFIGURACI√ìN
        // =================================================================
        const N8N_SEARCH_WEBHOOK = 'https://n8n-server.griffin-paridae.ts.net/webhook/Busqueda';
        const N8N_ADD_WEBHOOK = 'https://n8n-server.griffin-paridae.ts.net/webhook/A√±adir';
        // =================================================================
        // EVENT LISTENERS
        // =================================================================
        document.getElementById('search-button').addEventListener('click', searchSong);
        
        document.getElementById('song-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchSong();
            }
        });

        // =================================================================
        // B√öSQUEDA
        // =================================================================
        async function searchSong() {
            const query = document.getElementById('song-query').value.trim();
            
            if (!query) {
                showStatus('Por favor escribe el nombre de una canci√≥n', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('results');
            const searchButton = document.getElementById('search-button');
            const statusElement = document.getElementById('status');
            
            // Deshabilitar bot√≥n mientras se busca
            searchButton.disabled = true;
            searchButton.innerHTML = '<span class="spinner">‚è≥</span> Buscando...';
            
            resultsDiv.innerHTML = '<li class="loading"><span class="spinner">üîç</span> Buscando en Spotify...</li>';
            statusElement.textContent = '';

            try {
                const response = await fetch(N8N_SEARCH_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Respuesta de n8n:', data);
                
                // El workflow devuelve directamente el array de tracks o un objeto con tracks
                const tracks = Array.isArray(data) ? data : (data.tracks || []);
                
                if (tracks.length === 0) {
                    resultsDiv.innerHTML = '<li>üòï No se encontraron canciones con ese nombre</li>';
                    showStatus('Intenta con otro t√©rmino de b√∫squeda', 'warning');
                } else {
                    // Siempre mostrar resultados para que el usuario elija
                    renderResults(tracks);
                    showStatus(`Se encontraron ${tracks.length} resultado(s). Selecciona la canci√≥n:`, 'info');
                }

            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = '';
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showStatus('‚ùå No se puede conectar con el servidor. Verifica que n8n est√© en l√≠nea', 'error');
                } else {
                    showStatus(`‚ùå Error: ${error.message}`, 'error');
                }
            } finally {
                searchButton.disabled = false;
                searchButton.innerHTML = 'üîç Buscar';
            }
        }

        // =================================================================
        // RENDERIZAR RESULTADOS
        // =================================================================
        // =================================================================
        // RENDERIZAR RESULTADOS (VERSI√ìN CORREGIDA)
        // =================================================================
        function renderResults(tracks) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (!tracks || tracks.length === 0) {
                resultsDiv.innerHTML = '<li>No se encontraron canciones.</li>';
                return;
            }

            // 'tracks' es el array de JSON que recibimos
            tracks.forEach(track => {
                const li = document.createElement('li');
                
                // 1. Procesamos los artistas
                // track.artists es un array de objetos, los unimos en un string
                const artistNames = track.artists.map(artist => artist.name).join(', ');

                // 2. Procesamos el nombre del √°lbum
                // track.album es un objeto, sacamos su 'name'
                const albumName = track.album.name;

                // 3. Procesamos la car√°tula
                // track.album.images es un array, usamos la imagen mediana (√≠ndice 1) o la peque√±a (√≠ndice 2)
                const albumArtUrl = (track.album.images && track.album.images.length > 0)
                                    ? track.album.images[1].url // √çndice 1 es 300x300px
                                    : ''; // Fallback por si no hay imagen

                // 4. Construimos el HTML con las variables correctas
                li.innerHTML = `
                    <div class="track-info">
                        ${albumArtUrl ? `<img src="${albumArtUrl}" alt="Album" class="album-art">` : ''}
                        <div class="track-details">
                            <div class="track-name">${escapeHtml(track.name)}</div>
                            <div class="track-artist">${escapeHtml(artistNames)}</div>
                            ${albumName ? `<div class="track-album">${escapeHtml(albumName)}</div>` : ''}
                        </div>
                    </div>
                    <button class="send-button">‚úì A√±adir</button>
                `;
                
                resultsDiv.appendChild(li);

                // 5. Asignamos el listener al bot√≥n
                li.querySelector('.send-button').addEventListener('click', () => {
                    // Pasamos el URI de la canci√≥n, el nombre y el string de artistas
                    addToQueue(track.uri, track.name, artistNames);
                });
            });
        }
        // =================================================================
        // A√ëADIR A COLA (selecci√≥n manual)
        // =================================================================
        async function addToQueue(uri, name, artist) {
            const statusElement = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusElement.className = 'info';
            statusElement.textContent = `‚è≥ A√±adiendo "${name}" a la cola...`;

            try {
                const response = await fetch(N8N_ADD_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        uri: uri
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                // Respuesta exitosa (puede ser 204 No Content o JSON)
                resultsDiv.innerHTML = '';
                showStatus(`‚úÖ ¬°Perfecto! "${name}" se ha a√±adido a la cola`, 'success');
                document.getElementById('song-query').value = '';

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå Error al a√±adir la canci√≥n: ${error.message}`, 'error');
            }
        }

        // =================================================================
        // UTILIDADES
        // =================================================================
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.className = type;
            statusElement.textContent = message;
        }

        // ESTA ES LA VERSI√ìN CORREGIDA
function escapeHtml(text) {
    // ¬°NUEVO! Comprueba si el texto es nulo, indefinido o no es un string
    if (typeof text !== 'string') {
        return ''; // Devuelve una cadena vac√≠a en lugar de 'crashear'
    }

    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
    </script>
</body>
</html>