<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Canci√≥n a n8n por Spotify</title>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif; 
            padding: 20px; 
            background-color: #121212; 
            color: #FFFFFF; 
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { 
            color: #1DB954; 
            font-weight: 700; 
            margin-bottom: 25px; 
        }
        #search-container { 
            margin-bottom: 20px; 
            display: none;
            gap: 10px; 
        }
        #results { 
            list-style: none; 
            padding: 0; 
        }
        #results li { 
            padding: 12px; 
            margin-bottom: 8px; 
            border: 1px solid #333; 
            background-color: #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
        }
        #results li:hover { 
            background-color: #404040; 
            transition: background-color 0.2s; 
        }
        input[type="text"] { 
            padding: 10px; 
            flex: 1;
            background-color: #333; 
            border: 1px solid #535353; 
            color: white; 
            border-radius: 4px;
            font-size: 16px;
        }
        button { 
            background-color: #535353; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: background-color 0.3s;
            font-size: 14px;
        }
        button:hover { 
            background-color: #666; 
        }
        button:active {
            transform: scale(0.98);
        }
        #login-spotify {
            background-color: #1DB954;
            font-weight: bold;
            font-size: 16px;
            padding: 12px 24px;
        }
        #login-spotify:hover {
            background-color: #1ed760;
        }
        .send-button { 
            background-color: #1DB954; 
            font-weight: bold; 
        }
        .send-button:hover { 
            background-color: #1ed760; 
        }
        #status { 
            margin-top: 20px; 
            font-weight: bold; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .success { 
            background-color: #0b3d1b; 
            color: #1DB954; 
        }
        .error { 
            background-color: #4d0000; 
            color: #ff3333; 
        }
        .debug-info {
            background-color: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        .debug-info h3 {
            margin-top: 0;
            color: #1DB954;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üéµ Busca y Env√≠a una Canci√≥n a n8n</h1>
    
    <!-- Panel de Debug -->
    <div class="debug-info" id="debug-panel">
        <h3>üîß Panel de Diagn√≥stico</h3>
        <div id="debug-messages">
            <p>‚è≥ Cargando aplicaci√≥n...</p>
        </div>
    </div>
    
    <div id="auth-status">
        <button id="login-spotify">üéµ Iniciar Sesi√≥n con Spotify</button>
        <p style="color:#b3b3b3; margin-top: 10px;">Debes iniciar sesi√≥n con Spotify para buscar canciones.</p>
    </div>

    <div id="search-container">
        <input type="text" id="song-query" placeholder="Escribe el nombre de la canci√≥n..." >
        <button id="search-button">üîç Buscar</button>
    </div>

    <ul id="results"></ul>
    
    <div id="status"></div>

    <script>
        // =================================================================
        // CONFIGURACI√ìN
        // =================================================================
        const CLIENT_ID = 'd3f296d31bef403db8139d10c5ebfee3';
        const REDIRECT_URI = 'https://spotifyjam.vercel.app/';
        
        // ‚úÖ URL CORRECTA del webhook (sin proxy)
        const N8N_WEBHOOK_URL = 'https://n8n-server.griffin-paridae.ts.net/webhook-test/Busqueda';

        let accessToken = '';

        // =================================================================
        // FUNCI√ìN DE DEBUG
        // =================================================================
        function addDebugMessage(message, type = 'info') {
            const debugDiv = document.getElementById('debug-messages');
            const colors = {
                info: '#1DB954',
                error: '#ff3333',
                warning: '#ffaa00',
                success: '#1DB954'
            };
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<p style="color: ${colors[type]}; margin: 5px 0;">[${timestamp}] ${message}</p>`;
            console.log(message);
        }

        // =================================================================
        // VERIFICACI√ìN INICIAL
        // =================================================================
        addDebugMessage('‚úÖ Script cargado correctamente');
        addDebugMessage(`üìç CLIENT_ID: ${CLIENT_ID}`);
        addDebugMessage(`üìç REDIRECT_URI: ${REDIRECT_URI}`);
        addDebugMessage(`üìç N8N_WEBHOOK: ${N8N_WEBHOOK_URL}`);

        // Verificar que el bot√≥n existe
        window.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('login-spotify');
            if (loginBtn) {
                addDebugMessage('‚úÖ Bot√≥n de login encontrado');
            } else {
                addDebugMessage('‚ùå ERROR: Bot√≥n de login NO encontrado', 'error');
            }
        });

        // =================================================================
        // HELPERS PARA PKCE
        // =================================================================
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        // =================================================================
        // EVENTO DE LOGIN
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            addDebugMessage('üîµ DOM cargado, configurando listeners...');
            
            const loginBtn = document.getElementById('login-spotify');
            
            if (!loginBtn) {
                addDebugMessage('‚ùå CR√çTICO: No se encontr√≥ el bot√≥n de login', 'error');
                return;
            }

            loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                addDebugMessage('üîµ Click detectado en el bot√≥n de login', 'success');
                
                try {
                    addDebugMessage('‚è≥ Generando c√≥digo PKCE...');
                    const codeVerifier = generateRandomString(64);
                    const hashed = await sha256(codeVerifier);
                    const codeChallenge = base64urlencode(hashed);
                    
                    localStorage.setItem('code_verifier', codeVerifier);
                    addDebugMessage('‚úÖ Code verifier guardado');
                    
                    const scopes = 'user-read-private user-read-email';
                    
                    const authUrl = new URL('https://accounts.spotify.com/authorize');
                    const params = {
                        client_id: CLIENT_ID,
                        response_type: 'code',
                        redirect_uri: REDIRECT_URI,
                        scope: scopes,
                        code_challenge_method: 'S256',
                        code_challenge: codeChallenge
                    };
                    
                    authUrl.search = new URLSearchParams(params).toString();
                    
                    addDebugMessage('‚úÖ URL de autorizaci√≥n creada');
                    addDebugMessage(`üîó Redirigiendo a: ${authUrl.toString().substring(0, 100)}...`);
                    
                    setTimeout(() => {
                        window.location.href = authUrl.toString();
                    }, 500);
                    
                } catch (error) {
                    addDebugMessage(`‚ùå ERROR: ${error.message}`, 'error');
                    console.error(error);
                }
            });

            addDebugMessage('‚úÖ Listener de click configurado correctamente', 'success');
            
            handleCallback();
        });

        // =================================================================
        // CALLBACK DE SPOTIFY
        // =================================================================
        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            
            if (error) {
                addDebugMessage(`‚ùå Error de Spotify: ${error}`, 'error');
                return false;
            }
            
            if (code) {
                addDebugMessage('üîµ C√≥digo de autorizaci√≥n recibido', 'success');
                
                const codeVerifier = localStorage.getItem('code_verifier');
                
                if (!codeVerifier) {
                    addDebugMessage('‚ùå No se encontr√≥ code_verifier', 'error');
                    return false;
                }
                
                try {
                    addDebugMessage('‚è≥ Intercambiando c√≥digo por token...');
                    
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: CLIENT_ID,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.access_token) {
                        accessToken = data.access_token;
                        
                        const expiresAt = Date.now() + (data.expires_in * 1000);
                        localStorage.setItem('spotify_access_token', accessToken);
                        localStorage.setItem('spotify_token_expires_at', expiresAt);
                        
                        addDebugMessage('‚úÖ Token obtenido exitosamente', 'success');
                        
                        localStorage.removeItem('code_verifier');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        updateUIAfterLogin();
                        return true;
                    } else {
                        addDebugMessage(`‚ùå Error al obtener token: ${JSON.stringify(data)}`, 'error');
                        return false;
                    }
                    
                } catch (error) {
                    addDebugMessage(`‚ùå Error en el intercambio: ${error.message}`, 'error');
                    return false;
                }
            }
            
            const storedToken = localStorage.getItem('spotify_access_token');
            const expiresAt = localStorage.getItem('spotify_token_expires_at');
            
            if (storedToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                addDebugMessage('‚úÖ Token v√°lido encontrado en localStorage', 'success');
                accessToken = storedToken;
                updateUIAfterLogin();
                return true;
            }
            
            addDebugMessage('‚ÑπÔ∏è No hay sesi√≥n activa');
            return false;
        }

        // =================================================================
        // ACTUALIZAR UI
        // =================================================================
        function updateUIAfterLogin() {
            document.getElementById('auth-status').innerHTML = '<span class="success">‚úÖ Conectado a Spotify</span>';
            document.getElementById('search-container').style.display = 'flex';
            addDebugMessage('‚úÖ UI actualizada - Listo para buscar', 'success');
        }

        // =================================================================
        // B√öSQUEDA
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('search-button').addEventListener('click', async () => {
                const query = document.getElementById('song-query').value.trim();
                
                if (!query) {
                    alert('Por favor escribe el nombre de una canci√≥n');
                    return;
                }
                
                if (!accessToken) {
                    alert('Debes iniciar sesi√≥n primero');
                    return;
                }

                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '<li>Buscando...</li>';
                document.getElementById('status').textContent = '';

                try {
                    const response = await fetch(
                        `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=5`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );

                    if (response.status === 401) {
                        addDebugMessage('‚ùå Token expirado', 'error');
                        localStorage.removeItem('spotify_access_token');
                        localStorage.removeItem('spotify_token_expires_at');
                        accessToken = '';
                        
                        document.getElementById('status').className = 'error';
                        document.getElementById('status').textContent = '‚ö†Ô∏è Token expirado. Por favor, inicia sesi√≥n de nuevo.';
                        location.reload();
                        return;
                    }

                    const data = await response.json();
                    renderResults(data.tracks.items);

                } catch (error) {
                    addDebugMessage(`‚ùå Error en b√∫squeda: ${error.message}`, 'error');
                    resultsDiv.innerHTML = '<li style="color: red;">Error al realizar la b√∫squeda.</li>';
                }
            });

            document.getElementById('song-query').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-button').click();
                }
            });
        });

        // =================================================================
        // RENDERIZAR RESULTADOS
        // =================================================================
        function renderResults(tracks) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (tracks.length === 0) {
                resultsDiv.innerHTML = '<li>No se encontraron canciones.</li>';
                return;
            }

            tracks.forEach(track => {
                const li = document.createElement('li');
                const artistNames = track.artists.map(artist => artist.name).join(', ');
                
                li.innerHTML = `
                    <div>
                        <strong>${track.name}</strong> - ${artistNames}
                    </div>
                    <button class="send-button" data-uri="${track.uri}">Enviar a n8n</button>
                `;
                
                resultsDiv.appendChild(li);

                li.querySelector('.send-button').addEventListener('click', () => {
                    sendToN8n(track.uri, track.name, artistNames);
                });
            });
        }

        // =================================================================
        // ENV√çO A N8N
        // =================================================================
        async function sendToN8n(uri, name, artist) {
            const statusElement = document.getElementById('status');
            statusElement.className = '';
            statusElement.textContent = `Enviando "${name}" a tu flujo de n8n...`;
            
            addDebugMessage(`‚è≥ Enviando al webhook: ${name}`);

            const payload = {
                trackUri: uri,
                songName: name,
                artistName: artist,
                timestamp: new Date().toISOString()
            };

            addDebugMessage(`üì¶ Payload: ${JSON.stringify(payload, null, 2)}`);

            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                addDebugMessage(`üì° Respuesta HTTP: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    let responseData;
                    try {
                        responseData = await response.json();
                        addDebugMessage(`‚úÖ Respuesta de n8n: ${JSON.stringify(responseData)}`, 'success');
                    } catch {
                        responseData = await response.text();
                        addDebugMessage(`‚úÖ Respuesta de n8n (texto): ${responseData}`, 'success');
                    }
                    
                    statusElement.className = 'success';
                    statusElement.textContent = `‚úÖ ¬°√âxito! "${name}" ha sido enviada a n8n.`;
                    addDebugMessage(`‚úÖ Canci√≥n enviada: ${name}`, 'success');
                } else {
                    const errorText = await response.text();
                    addDebugMessage(`‚ùå Error HTTP ${response.status}: ${errorText}`, 'error');
                    statusElement.className = 'error';
                    statusElement.textContent = `‚ùå Error de n8n (${response.status}): ${errorText}`;
                }

            } catch (error) {
                addDebugMessage(`‚ùå Error cr√≠tico: ${error.message}`, 'error');
                addDebugMessage(`‚ùå Tipo de error: ${error.name}`, 'error');
                
                if (error.message.includes('fetch') || error.name === 'TypeError') {
                    statusElement.className = 'error';
                    statusElement.innerHTML = `
                        ‚ùå <strong>Error CORS</strong>: El webhook de n8n no acepta peticiones desde este dominio.<br>
                        <small style="display: block; margin-top: 10px;">
                        üîß Soluci√≥n: En tu flujo de n8n, ve al nodo Webhook y activa:<br>
                        ‚Ä¢ "Respond" ‚Üí "Immediately"<br>
                        ‚Ä¢ En Response Headers, a√±ade headers CORS
                        </small>
                    `;
                } else {
                    statusElement.className = 'error';
                    statusElement.textContent = `‚ùå Error: ${error.message}`;
                }
            }
        }
    </script>
</body>
</html>